import React, { useState, useEffect, useRef } from 'react';
import { ShoppingBag, UtensilsCrossed, Cake, ChevronRight, Check, Copy, ArrowLeft, Heart, Bone, Palette, Leaf, Info, Wand2, Loader2, Circle, AlertCircle, Save, Trash2, Plus, Sparkles, Truck, Database, FileText, ShieldCheck } from 'lucide-react';

// --- CSS Styles ---
const styles = `
  @keyframes float {
    0% { transform: translate(0px, 0px) scale(1); }
    33% { transform: translate(30px, -50px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    100% { transform: translate(0px, 0px) scale(1); }
  }
  .blob-animation {
    animation: float 7s infinite;
  }
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  /* Modal Animation */
  @keyframes modal-pop {
    0% { opacity: 0; transform: scale(0.9); }
    100% { opacity: 1; transform: scale(1); }
  }
  .animate-modal {
    animation: modal-pop 0.3s ease-out forwards;
  }
`;

// --- Static Data ---
const CATEGORIES_DATA = {
  shape: { title: "è¼•é£Ÿé¸æ“‡", icon: <UtensilsCrossed className="w-5 h-5" />, items: [{ id: 'donut', name: 'ç”œç”œåœˆ (2å€‹/ä»½)', price: 240, desc: 'å¯æ„›åœ“æ½¤é€ å‹ï¼Œä¸€ä»½åŒ…å« 2 å€‹ç”œç”œåœˆã€‚' }, { id: 'paw', name: 'çˆªç‹€è‚‰é¤… (3å€‹/ä»½)', price: 300, desc: 'èŒèŒè‚‰çƒé€ å‹ï¼Œä¸€ä»½åŒ…å« 3 å€‹è‚‰é¤…ã€‚' }] },
  meat: { title: "è‚‰é¡ä¸»é£Ÿ", icon: <Bone className="w-5 h-5" />, items: [{ id: 'A', name: 'ç‰›è‚‰', price: 300, desc: 'é«˜éµã€é«˜é‹…ã€Bç¾¤è±å¯Œï¼Œå¢å¼·å…ç–«åŠ›èˆ‡è‚Œè‚‰ç™¼å±•ã€‚' }, { id: 'B', name: 'é›è‚‰', price: 200, desc: 'é«˜è›‹ç™½ã€ä½è„‚ã€‚' }, { id: 'C', name: 'é¯›é­š', price: 250, desc: 'é«˜è›‹ç™½ã€ä½è„‚è‚ªï¼Œé©åˆæ¸›è‚¥èˆ‡è…ç—…ç®¡ç†ã€‚' }, { id: 'D', name: 'é®­é­š', price: 300, desc: 'å«Omega-3è„‚è‚ªé…¸ã€EPAã€DHAï¼Œä¿è­·å¿ƒè¡€ç®¡èˆ‡çš®è†šã€‚' }, { id: 'E', name: 'è¦å­', price: 250, desc: 'å„ªè³ªè›‹ç™½è³ªã€Omega-3ã€ç‰›ç£ºé…¸ã€‚çš®è†šå¥åº·ã€æ¯›é«®äº®éº—ã€‚' }, { id: 'F', name: '', price: 200, desc: 'éµèˆ‡é‹…å«é‡é«˜ï¼Œå¹«åŠ©æ¶ˆåŒ–èˆ‡è£œæ°£è¡€ï¼Œé©å£æ€§ä½³ã€‚' }] },
  veg: { title: "è”¬èœé…æ–™", icon: <Leaf className="w-5 h-5" />, items: [{ id: 'a', name: 'è èœ', price: 100, desc: 'éµè³ªèˆ‡è‘‰é…¸è±å¯Œã€‚' }, { id: 'b', name: 'èŠ±æ¤°èœ', price: 100, desc: 'å¹«åŠ©æŠ—æ°§åŒ–ã€æ¸…è‚æ’æ¯’ã€ä¿ƒé€²å…ç–«ç³»çµ±ã€‚' }, { id: 'c', name: 'è²“è–„è·', price: 50, desc: 'å¹«åŠ©æƒ…ç·’æ”¾é¬†è§£å£“ï¼Œå®‰æ’«(ç‹—ç‹—ä¹Ÿå¯ä»¥åƒå–”!)ã€‚' }, { id: 'd', name: 'å—ç“œ', price: 100, desc: 'é«˜çº–ç¶­ï¼Œæœ‰åŠ©è…¸èƒƒè •å‹•èˆ‡è»Ÿä¾¿ã€‚' }, { id: 'e', name: 'åœ°ç“œ', price: 100, desc: 'å¹«åŠ©è…¸èƒƒè •å‹•ï¼Œå«æŠ—æ°§åŒ–ç‰©ï¼Œå¢åŠ é£½è¶³æ„Ÿã€‚' }, { id: 'f', name: 'ç´«è–¯', price: 100, desc: 'å¹«åŠ©è…¸èƒƒè •å‹•ï¼Œä¿ƒé€²æ’ä¾¿æ”¹å–„æ¯›çƒã€ä¾¿ç§˜ã€‚' }, { id: 'g', name: 'ç´…è˜¿è””', price: 100, desc: 'Î²-èƒ¡è˜¿è””ç´ ï¼Œå¹«åŠ©å¢å¼·å…ç–«ã€ä¿è­·çœ¼ç›ã€ä¿ƒé€²çš®è†šå¥åº·ã€‚' }, { id: 'h', name: 'ç™½è˜¿è””', price: 100, desc: 'å¹«åŠ©æ¶ˆåŒ–ã€å»è„¹æ°£ã€‚' }, { id: 'i', name: 'å°é»ƒç“œ', price: 100, desc: 'å«æ°´é‡é«˜ï¼Œæœ‰åŠ©è§£æš‘èˆ‡è£œæ°´ã€‚' }, { id: 'j', name: 'å±±è—¥', price: 150, desc: 'å¹«åŠ©è…¸èƒƒã€æŠ—ç™¼ç‚ï¼Œè†³é£Ÿçº–ç¶­è±å¯Œã€‚' }] },
  fruit: { title: "æ°´æœé»ç¶´", icon: <Heart className="w-5 h-5" />, items: [{ id: '1', name: 'è˜‹æœ', price: 100, desc: 'ç¶­ç”Ÿç´ Cã€è†³é£Ÿçº–ç¶­ï¼Œæœ‰åŠ©æ¶ˆåŒ–ã€æ•´è…¸ã€é™ä½å£è‡­ã€‚' }, { id: '2', name: 'é¦™è•‰', price: 100, desc: 'é‰€è±å¯Œï¼Œå¹«åŠ©å¿ƒè‡Ÿèˆ‡ç¥ç¶“åŠŸèƒ½ï¼Œä¾¿ç§˜å¯é£Ÿç”¨ã€‚' }, { id: '3', name: 'è—è“', price: 200, desc: 'å¹«åŠ©æŠ—æ°§åŒ–ã€ä¿è­·è¦–åŠ›ã€æ¸›ç·©è€åŒ–ã€‚' }, { id: '4', name: 'æœ¨ç“œ', price: 150, desc: 'æœ¨ç“œé…µç´ å¯å¹«åŠ©æ¶ˆåŒ–ï¼Œå¯Œå«ç¶­ç”Ÿç´ Cã€Aã€‚' }, { id: '5', name: 'å°ç•ªèŒ„', price: 100, desc: 'å¯Œå«ç¶­ç”Ÿç´ Cã€Aã€çº–ç¶­ï¼Œæœ‰åŠ©æ¶ˆåŒ–èˆ‡æŠ—æ°§åŒ–ã€‚' }] },
  color: { title: "æ·‹é¢é¡è‰²", icon: <Palette className="w-5 h-5" />, items: [{ id: '@', name: 'è—è‰²', price: 100, desc: 'è¶è±†èŠ±ç²‰', colorCode: '#A0C4FF' }, { id: '#', name: 'ç¶ è‰²', price: 100, desc: 'è èœç²‰', colorCode: '#BDB2FF' }, { id: '+', name: 'ç´…è‰²', price: 100, desc: 'ç´…ç”œèœæ ¹ç²‰', colorCode: '#FFADAD' }, { id: '-', name: 'é»ƒè‰²', price: 100, desc: 'è–‘é»ƒç²‰', colorCode: '#FDFFB6' }, { id: '%', name: 'ç´«è‰²', price: 100, desc: 'ç´«è–¯æ³¥', colorCode: '#E7C6FF' }] }
};

// --- Sub-components ---
const PageContainer = ({ children }) => (
  <div className="fixed inset-0 bg-[#fdfbf7] font-sans text-[#5d4037] overflow-hidden flex justify-center">
    <style>{styles}</style>
    <div className="w-full max-w-[1024px] relative bg-[#fdfbf7] h-full flex flex-col shadow-2xl">
      {children}
    </div>
  </div>
);

const CategoryTab = ({ id, label, icon, isActive, onClick }) => (
  <button onClick={() => onClick(id)} className={`flex items-center space-x-2 px-4 py-3 rounded-full transition-all duration-300 whitespace-nowrap border ${isActive ? 'bg-[#8b5e3c] text-white border-[#8b5e3c] shadow-md transform scale-105' : 'bg-white text-[#8b5e3c] border-[#e6ccb2] hover:bg-[#f0e6dd]'}`}>
    {icon}<span className="font-medium tracking-wide">{label}</span>
  </button>
);

const IngredientCard = ({ item, category, isSelected, onToggle, formatPrice }) => {
  return (
    <div onClick={() => onToggle(category, item)} className={`relative overflow-hidden rounded-2xl p-4 cursor-pointer transition-all duration-300 border-2 flex flex-col h-full bg-white ${isSelected ? 'border-[#8b5e3c] bg-[#fffbf7] shadow-md scale-[1.02]' : 'border-transparent hover:border-[#e6ccb2] shadow-sm'}`}>
      <div className="flex justify-between items-start mb-2"><h3 className="text-lg font-bold text-[#5d4037]">{item.name}</h3>{item.price > 0 && (<span className="bg-[#d4a373] text-white text-xs px-2 py-1 rounded-full whitespace-nowrap">{formatPrice(item.price)}</span>)}</div>
      <p className="text-xs text-[#8b5e3c] opacity-80 leading-relaxed mb-6 flex-grow">{item.desc}</p>
      {category === 'color' && (<div className="absolute top-2 right-12 w-4 h-4 rounded-full border border-gray-200" style={{ backgroundColor: item.colorCode || '#ddd' }} />)}
      <div className={`absolute bottom-3 right-3 w-6 h-6 rounded-full flex items-center justify-center transition-colors ${isSelected ? 'bg-[#8b5e3c]' : 'bg-[#e6ccb2]'}`}>{isSelected && <Check className="w-4 h-4 text-white" />}</div>
    </div>
  );
};

// --- Notification Modal Component ---
const NotificationModal = ({ message, onConfirm, buttonText = "OK", icon }) => (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm px-6">
        <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full border-4 border-[#faedcd] animate-modal flex flex-col items-center text-center">
            <div className="bg-[#faedcd] p-3 rounded-full mb-4">
                {icon || <Truck className="w-8 h-8 text-[#8b5e3c]" />}
            </div>
            <p className="text-lg font-bold text-[#5d4037] mb-6 leading-relaxed">
                {message}
            </p>
            <button 
                onClick={onConfirm}
                className="w-full bg-[#8b5e3c] text-white py-3 rounded-xl font-bold text-lg shadow-md active:scale-95 hover:bg-[#7a5235] transition-all"
            >
                {buttonText}
            </button>
        </div>
    </div>
);

// --- Main App ---
const Ho00pApp = () => {
  // âš ï¸ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€
  const googleScriptUrl = "https://script.google.com/macros/s/AKfycbyRecYYd6Dp01MZyZqsJ1wczJIMpcJc8LTz90p7Y8fNjOA38zXEdJuOGbz2KybfBe1KeA/exec"; 

  // State
  const [page, setPage] = useState('home'); 
  const [orderType, setOrderType] = useState(null); 
  const [cart, setCart] = useState([]);
  const [selections, setSelections] = useState({ shape: [], meat: [], veg: [], fruit: [], color: [] });
  const [activeTab, setActiveTab] = useState('meat');
  const [isCartBarVisible, setIsCartBarVisible] = useState(true);
  const scrollRef = useRef(null);
  const lastScrollTop = useRef(0);
  const [toast, setToast] = useState(null); 
  
  // Notification State
  const [showNotice1, setShowNotice1] = useState(true); 
  const [showNotice2, setShowNotice2] = useState(false);
  const [showNotice3, setShowNotice3] = useState(false);
  
  // Greeting State
  const [petName, setPetName] = useState('');
  const [occasion, setOccasion] = useState(''); 
  const [aiGreeting, setAiGreeting] = useState('');

  // Admin State (åº—ä¸»è¨˜å¸³ç”¨) - ç§»é™¤é£¼ä¸»å§“åï¼Œä¿ç•™å…¶ä»–
  const [adminInput, setAdminInput] = useState('');
  const [parsedData, setParsedData] = useState(null);
  const [adminPhone, setAdminPhone] = useState('');
  const [adminAddress, setAdminAddress] = useState('');
  const [adminLast5, setAdminLast5] = useState('');
  const [adminNote, setAdminNote] = useState('');
  const [clickCount, setClickCount] = useState(0);

  // Helper
  const formatPrice = (price) => `$${price}`;
  const showToast = (message, type = 'success') => {
    setToast({ message, type });
    setTimeout(() => setToast(null), 5000);
  };

  const handleConfirmNotice1 = () => { setShowNotice1(false); setShowNotice2(true); };
  const handleConfirmNotice2 = () => { setShowNotice2(false); setShowNotice3(true); };
  const handleConfirmNotice3 = () => { setShowNotice3(false); };

  const handleScroll = () => {
    const container = scrollRef.current;
    if (!container) return;
    const currentScroll = container.scrollTop;
    if (Math.abs(currentScroll - lastScrollTop.current) < 15) return;
    if (currentScroll > lastScrollTop.current && currentScroll > 50) setIsCartBarVisible(false);
    else setIsCartBarVisible(true);
    lastScrollTop.current = currentScroll;
  };
  useEffect(() => { setIsCartBarVisible(true); }, [activeTab]);

  const handleLogoClick = () => {
    setClickCount(prev => prev + 1);
    if (clickCount + 1 >= 5) {
      setPage('admin');
      setClickCount(0);
      showToast("é€²å…¥åº—ä¸»è¨˜å¸³æ¨¡å¼ ğŸ“", "success");
    }
  };

  // ğŸ“ æ™ºæ…§è¨‚å–®è§£æå™¨ (ä¿®å¾©ç‰ˆ)
  const parseOrderText = () => {
    if (!adminInput) return;
    const text = adminInput;
    
    // 1. æŠ“å–å¯µç‰©åèˆ‡å‚™è¨» (ç”Ÿæ—¥)
    // ä¿®æ”¹Regexï¼šå¿½ç•¥ Emoji å’Œç‰¹æ®Šç¬¦è™Ÿï¼ŒæŠ“å– "çš„" ä¹‹å¾Œåˆ° "è¨‚è³¼å–®" ä¹‹å‰çš„å…§å®¹
    const titleMatch = text.match(/ã€\s*(.*?)\s*çš„\s*(.*?)\s*è¨‚è³¼å–®/);
    
    let name = "æœªæŠ“å–åˆ°";
    let note = "";
    
    if (titleMatch) {
        name = titleMatch[1].trim();
        note = titleMatch[2].trim(); // é€™è£¡æœƒæŠ“åˆ° "äº”æ­²ç”Ÿæ—¥"
    } else {
        const simpleMatch = text.match(/ã€\s*(.*?)\s*çš„/);
        if (simpleMatch) name = simpleMatch[1].trim();
    }

    // 2. æŠ“å–é‡‘é¡
    const priceMatch = text.match(/è¨‚å–®ç¸½é‡‘é¡ï¼š\s*\$([\d,]+)/);
    const price = priceMatch ? priceMatch[1].replace(/,/g, '') : "0";

    // 3. æŠ“å–é›»è©±
    const phoneMatch = text.match(/å®¶é•·é›»è©±ï¼š\s*\n\s*([0-9-]+)/);
    const phone = phoneMatch ? phoneMatch[1].trim() : "";

    // 4. æŠ“å–å¾Œäº”ç¢¼
    const last5Match = text.match(/å¸³è™Ÿå¾Œäº”ç¢¼ï¼š\s*\n\s*(\d+)/);
    const last5 = last5Match ? last5Match[1].trim() : "";

    // 5. æŠ“å–åœ°å€
    const addressMatch = text.match(/æ”¶ä»¶åœ°å€ï¼š\s*\n\s*(.+)/);
    const address = addressMatch ? addressMatch[1].trim() : "";

    // 6. æŠ“å–è¨‚å–®å…§å®¹
    let content = "è©³ç´°å…§å®¹è«‹è¦‹åŸå§‹æ–‡å­—";
    const startContent = text.indexOf("ã€‘");
    const endContent = text.indexOf("------------------");
    
    if (startContent > 0 && endContent > startContent) {
        content = text.substring(startContent + 1, endContent).trim();
    }
    
    // é¡å‹åˆ¤æ–·
    let type = "æ··åˆè¨‚å–®";
    if (content.includes("è¼•é£Ÿé¤é»") && !content.includes("å®¢è£½åŒ–è›‹ç³•")) type = "è¼•é£Ÿ";
    if (!content.includes("è¼•é£Ÿé¤é»") && content.includes("å®¢è£½åŒ–è›‹ç³•")) type = "è›‹ç³•";

    setParsedData({
        petName: name,
        price: price,
        type: type,
        content: content 
    });
    
    // è‡ªå‹•å¡«å…¥
    setAdminPhone(phone);
    setAdminLast5(last5);
    setAdminAddress(address);
    setAdminNote(note); // é€™è£¡æœƒè‡ªå‹•å¸¶å…¥ "äº”æ­²ç”Ÿæ—¥"
    
    showToast("âœ… è¨‚å–®æ™ºæ…§è§£æå®Œæˆï¼", "success");
  };

  const handleSubmitToGoogle = async () => {
    if (!googleScriptUrl) return showToast("å°šæœªè¨­å®š Google Script ç¶²å€", "error");
    if (!parsedData) return;
    try {
        const payload = {
            petName: parsedData.petName,
            content: parsedData.content,
            ownerName: "", // ç§»é™¤é£¼ä¸»å§“å
            phone: adminPhone,
            address: adminAddress,
            price: parsedData.price,
            note: adminNote,
            last5: adminLast5
        };
        await fetch(googleScriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        showToast("âœ… è¨˜å¸³æˆåŠŸï¼", "success");
        setAdminInput(''); setParsedData(null); 
        setAdminPhone(''); setAdminAddress(''); setAdminLast5(''); setAdminNote('');
    } catch (e) { showToast("âŒ é€£ç·šå¤±æ•—", "error"); }
  };

  const startOrder = (type) => { setOrderType(type); setPage('builder'); setSelections({ shape: [], meat: [], veg: [], fruit: [], color: [] }); setIsCartBarVisible(true); if (type === 'meal') setActiveTab('shape'); else setActiveTab('meat'); };
  const toggleSelection = (category, item) => { const list = selections[category] || []; const exists = list.find(i => i.id === item.id); const limits = { meat: 3, veg: 3, fruit: 1, color: 1, shape: 99 }; const limit = limits[category]; if (exists) { setSelections(prev => ({ ...prev, [category]: prev[category].filter(i => i.id !== item.id) })); } else { if (limit === 1) { setSelections(prev => ({ ...prev, [category]: [item] })); } else if (list.length >= limit) { showToast(`æ­¤é¡åˆ¥æœ€å¤šåªèƒ½é¸æ“‡ ${limit} ç¨®å–”ï¼`, 'error'); } else { setSelections(prev => ({ ...prev, [category]: [...prev[category], item] })); } } };
  const calculateCurrentItemTotal = () => { let total = 0; Object.keys(selections).forEach(key => { selections[key].forEach(item => total += item.price); }); return total; };
  const handleAddToCart = () => { const currentTotal = calculateCurrentItemTotal(); if (currentTotal === 0) return showToast('è«‹å…ˆé¸æ“‡é¤é»å…§å®¹å–”ï¼', 'error'); if (orderType === 'meal' && selections.shape.length === 0) return showToast('è¼•é£Ÿè«‹å…ˆé¸æ“‡è‡³å°‘ä¸€ç¨®é¤é»å–”ï¼', 'error'); if (orderType === 'cake') { if (selections.meat.length === 0) return showToast('æ‚¨çš„è›‹ç³•è¨‚å–®é‚„æ²’é¸ã€Œè‚‰é¡ä¸»é£Ÿã€å–”ï¼', 'error'); if (selections.color.length === 0) return showToast('æ‚¨çš„è›‹ç³•è¨‚å–®é‚„æ²’é¸ã€Œæ·‹é¢é¡è‰²ã€å–”ï¼', 'error'); } const newItem = { id: Date.now(), type: orderType, selections: { ...selections }, total: currentTotal }; setCart(prev => [...prev, newItem]); setPage('summary'); showToast('å·²åŠ å…¥è³¼ç‰©è»Šï¼', 'success'); };
  const calculateCartSubtotal = () => cart.reduce((acc, item) => acc + item.total, 0); 
  const calculateCartTotal = () => {
      const subtotal = calculateCartSubtotal();
      const shipping = subtotal >= 1000 ? 0 : 180;
      return subtotal + shipping;
  };
  const removeFromCart = (itemId) => setCart(prev => prev.filter(item => item.id !== itemId));
  const getCartIngredientsArray = () => { let list = []; cart.forEach(cartItem => { Object.values(cartItem.selections).forEach(arr => { arr.forEach(i => list.push(i.name)); }); }); return [...new Set(list)]; };

  const generateOrderText = () => {
    const name = petName.trim();
    const occ = occasion.trim();
    let text = 'ã€ Ho00p è¨‚è³¼å–® ã€‘\n\n';
    if (name) {
        if (occ.includes("ç”Ÿæ—¥")) {
             const ageMatch = occ.match(/(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)/);
             const ageStr = ageMatch ? ageMatch[0] : "";
             text = `ã€ ${name}çš„ ${ageStr}æ­²ç”Ÿæ—¥è¨‚è³¼å–® ğŸ‚ ã€‘\n\n`;
        } else {
             text = `ã€ ${name}çš„ è¨‚è³¼å–® ã€‘\n\n`;
        }
    }
    
    cart.forEach((item, index) => {
        const title = item.type === 'cake' ? `ğŸ‚ å®¢è£½åŒ–è›‹ç³• #${index + 1}` : `ğŸ¥¯ è¼•é£Ÿé¤é» #${index + 1}`;
        text += `${title}\n`;
        if (item.selections.shape.length > 0) text += `  å“é …ï¼š${item.selections.shape.map(i => i.name).join(', ')}\n`;
        if (item.selections.meat.length > 0) text += `  è‚‰é¡ï¼š${item.selections.meat.map(i => i.name).join(', ')}\n`;
        if (item.selections.veg.length > 0) text += `  è”¬èœï¼š${item.selections.veg.map(i => i.name).join(', ')}\n`;
        if (item.selections.fruit.length > 0) text += `  æ°´æœï¼š${item.selections.fruit.map(i => i.name).join(', ')}\n`;
        if (item.selections.color.length > 0) text += `  æ·‹é¢ï¼š${item.selections.color.map(i => i.name).join(', ')}\n`;
        text += `  å–®é …é‡‘é¡ï¼š${formatPrice(item.total)}\n\n`;
    });
    
    const subtotal = calculateCartSubtotal();
    const shipping = subtotal >= 1000 ? 0 : 180;
    const finalTotal = subtotal + shipping;

    text += '------------------\n';
    text += `å•†å“ç¸½é¡ï¼š${formatPrice(subtotal)}\n`;
    text += `é‹è²»ï¼š${shipping === 0 ? '$0 (æ»¿åƒå…é‹)' : '$180 (æœªæ»¿$1000)'}\n`;
    text += `ğŸ’° è¨‚å–®ç¸½é‡‘é¡ï¼š${formatPrice(finalTotal)}\n\n`;
    
    text += `æƒ³è«‹å•è©³ç´°è£½ä½œæ™‚é–“èˆ‡å–è²¨æ–¹å¼ï¼`;
    return text;
  };

  const handleCopy = () => {
    if (cart.length === 0) return showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼', 'error');
    const text = generateOrderText();
    try {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed"; textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus(); textArea.select();
      const success = document.execCommand('copy');
      document.body.removeChild(textArea);
      if (success) {
        showToast('è¨‚å–®å·²è¤‡è£½ï¼å³å°‡è·³è½‰è‡³ LINE...', 'success');
        setTimeout(() => { window.location.href = 'https://line.me/R/ti/p/@910bufim'; }, 1500);
      } else { showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error'); }
    } catch (e) { showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error'); }
  };

  const generateLocalGreeting = (name, occasion, ingredients) => {
    const occasionStr = occasion.trim();
    const nameStr = name.trim();
    let line1 = `è¦ªæ„›çš„ ${nameStr} ï½`;
    if (occasionStr.includes("ç”Ÿæ—¥")) {
        const ageMatch = occasionStr.match(/(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)/);
        line1 = ageMatch ? `è¦ªæ„›çš„ ${nameStr} ${ageMatch[0]}æ­²ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚` : `è¦ªæ„›çš„ ${nameStr} ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚`;
    }
    let line2 = "ä»Šå¤©çš„é¤é»è¶…è±ç››ï¼è¦é ­å¥½å£¯å£¯å–”ï¼"; 
    const ingr = ingredients.map(i => i.toLowerCase());
    if (ingr.includes('é®­é­š') || ingr.includes('è¦å­')) line2 = "çš®è†šè¦äº®äº®çš„ï¼Œçœ¼ç›è¦é¡§å¥½å–”ï¼ğŸ‘€";
    else if (ingr.includes('å—ç“œ') || ingr.includes('åœ°ç“œ')) line2 = "é€™äº›è†³é£Ÿçº–ç¶­è¦å¥½å¥½ä¿è­·ä½ çš„å°è‚šå­ï¼";
    else if (ingr.includes('ç‰›è‚‰') || ingr.includes('é›è‚‰')) line2 = "è›‹ç™½è³ªæ»¿åˆ†ï¼åƒå…‰å…‰æ‰èƒ½é•·å¾—å£¯å£¯çš„ï¼ğŸ’ª";
    const line3 = "è¦å¥å¥åº·åº·çš„å–”â¤ï¸";
    return `${line1}\n${line2}\n${line3}`;
  };

  const handleSavePetData = () => {
    if (!petName) return showToast("è«‹è¼¸å…¥åå­—", "error");
    const ingredients = getCartIngredientsArray();
    const generatedGreeting = generateLocalGreeting(petName, occasion, ingredients);
    setAiGreeting(generatedGreeting);
    showToast("è³‡æ–™å·²å„²å­˜ï¼");
  };

  // --- Render ---

  // 0. Notifications Overlay
  const renderNotifications = () => {
      if (showNotice1) {
          return <NotificationModal message="å…¨å“é …æ¡ç•¶æ—¥æ–°é®®é£Ÿæï¼Œç„¡é¡å¤–æ·»åŠ ç‰©ï¼Œå®‰å…¨è«‹æ”¾å¿ƒã€‚ â¤ï¸" onConfirm={handleConfirmNotice1} icon={<ShieldCheck className="w-8 h-8 text-[#8b5e3c]" />} />;
      }
      if (showNotice2) {
          return <NotificationModal message="é‹é€åªé™å°ç£æœ¬å³¶ï¼Œé›¢å³¶ç„¡æ³•å¯„é€è«‹è¦‹è«’ ğŸšš" onConfirm={handleConfirmNotice2} icon={<Truck className="w-8 h-8 text-[#8b5e3c]" />} />;
      }
      if (showNotice3) {
          return <NotificationModal message="é»‘è²“ä½æº«å®…æ€¥ä¾¿æ»¿åƒå«é‹ï¼Œæœªé” $1000 é…Œæ”¶ $180 é‹è²» ğŸ’°" onConfirm={handleConfirmNotice3} icon={<ShoppingBag className="w-8 h-8 text-[#8b5e3c]" />} />;
      }
      return null;
  };

  // 1. Admin Page
  if (page === 'admin') {
      return (
        <PageContainer>
            {renderNotifications()}
            <div className="flex items-center justify-between p-4 bg-white shadow-sm">
                <button onClick={() => setPage('home')} className="p-2 rounded-full hover:bg-gray-100 text-[#8b5e3c]"><ArrowLeft/></button>
                <h2 className="text-xl font-bold text-[#5d4037] flex items-center"><Database className="mr-2"/> åº—ä¸»è¨˜å¸³å¾Œå°</h2>
                <div className="w-8"></div>
            </div>
            
            <div className="p-6 flex-1 overflow-y-auto">
                <div className="mb-6">
                    <label className="block text-sm font-bold text-[#8b5e3c] mb-2">è«‹å°‡æ‰€æœ‰æ–‡å­—(å«è¨‚å–®+å®¢äººå›å‚³è³‡æ–™)å…¨éƒ¨è²¼ä¸Šï¼š</label>
                    <textarea 
                        className="w-full h-64 p-3 border-2 border-[#e6ccb2] rounded-xl focus:border-[#8b5e3c] text-sm"
                        placeholder="é•·æŒ‰è²¼ä¸Š LINE çš„å®Œæ•´å°è©±å…§å®¹..."
                        value={adminInput}
                        onChange={(e) => setAdminInput(e.target.value)}
                    />
                    <button onClick={parseOrderText} className="mt-2 w-full bg-[#8b5e3c] text-white py-2 rounded-lg font-bold shadow-sm active:scale-95"><Wand2 className="w-4 h-4 inline mr-1"/> è§£æè³‡æ–™</button>
                </div>
                {parsedData && (
                    <div className="bg-[#fffbf7] p-4 rounded-xl border border-[#d4a373] space-y-4 animate-fade-in-up">
                        <div className="flex justify-between border-b border-[#e6ccb2] pb-2"><span className="text-[#a67c52]">å¯µç‰©åï¼š<span className="text-[#5d4037] font-bold">{parsedData.petName}</span></span><span className="text-[#a67c52]">é‡‘é¡ï¼š<span className="text-[#5d4037] font-bold">${parsedData.price}</span></span></div>
                        
                        <div><label className="block text-xs font-bold text-[#8b5e3c] mb-1">é£¼ä¸»é›»è©±</label><input type="tel" value={adminPhone} onChange={e => setAdminPhone(e.target.value)} className="w-full p-2 border border-[#e6ccb2] rounded-lg"/></div>
                        <div><label className="block text-xs font-bold text-[#8b5e3c] mb-1">åœ°å€</label><input type="text" value={adminAddress} onChange={e => setAdminAddress(e.target.value)} className="w-full p-2 border border-[#e6ccb2] rounded-lg"/></div>
                        <div><label className="block text-xs font-bold text-[#8b5e3c] mb-1">åŒ¯æ¬¾å¾Œäº”ç¢¼</label><input type="text" value={adminLast5} onChange={e => setAdminLast5(e.target.value)} className="w-full p-2 border border-[#e6ccb2] rounded-lg"/></div>
                        <div><label className="block text-xs font-bold text-[#8b5e3c] mb-1">å‚™è¨» (å¹´é½¡/ç”¨é€”)</label><input type="text" value={adminNote} onChange={e => setAdminNote(e.target.value)} className="w-full p-2 border border-[#e6ccb2] rounded-lg"/></div>
                        
                        <button onClick={handleSubmitToGoogle} className="w-full bg-[#06C755] text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 flex items-center justify-center"><FileText className="w-5 h-5 mr-2"/> é€å‡ºè¨˜å¸³</button>
                    </div>
                )}
            </div>
        </PageContainer>
      );
  }

  // 2. Home Page
  if (page === 'home') {
    return (
      <PageContainer>
        {renderNotifications()}
        <div className="flex-1 flex flex-col items-center justify-center p-6 relative overflow-y-auto no-scrollbar w-full">
          <div className="absolute top-0 left-0 w-64 h-64 bg-[#faedcd] rounded-full mix-blend-multiply filter blur-3xl opacity-70 blob-animation" style={{ animationDelay: '0s' }}></div>
          <div className="absolute bottom-0 right-0 w-64 h-64 bg-[#e6ccb2] rounded-full mix-blend-multiply filter blur-3xl opacity-70 blob-animation" style={{ animationDelay: '2s' }}></div>

          <div className="text-center z-10 mb-8 mt-4">
             <div className="mb-4" onClick={handleLogoClick}>
                <h1 className="text-6xl font-black text-[#8b5e3c] tracking-tight mix-blend-multiply cursor-pointer select-none" style={{fontFamily: '"Times New Roman", serif'}}>Ho00p</h1>
            </div>
            <p className="text-[#a67c52] text-xl tracking-widest font-light">å¯µç‰©è›‹ç³• & è¼•é£Ÿ</p>
            <div className="h-1 w-24 bg-[#d4a373] mx-auto mt-4 rounded-full"></div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl z-10 px-4 mb-8">
            <button onClick={() => startOrder('cake')} className="group bg-white p-6 rounded-[2rem] shadow-xl hover:shadow-2xl transition-all border-2 border-[#f0e6dd] hover:border-[#d4a373] text-left flex flex-col justify-between min-h-[220px] relative overflow-hidden">
               <div className="absolute right-[-20px] bottom-[-20px] opacity-10"><Cake size={150} color="#8b5e3c"/></div>
               <div className="flex items-center space-x-4 mb-4"><div className="bg-[#faedcd] p-3 rounded-full"><Cake className="text-[#8b5e3c] w-8 h-8" /></div><h2 className="text-2xl font-bold text-[#5d4037]">å®¢è£½åŒ–è›‹ç³•</h2></div>
               <p className="text-[#8b5e3c] opacity-70 text-sm md:text-base">å°ˆå±¬æ…¶ç”Ÿã€ç¯€æ—¥æ…¶ç¥ã€‚<br/>åŒ…å«æ·‹é¢è¨­è¨ˆèˆ‡è±å¯Œé…æ–™ã€‚</p>
               <div className="mt-4 flex items-center text-[#d4a373] font-bold group-hover:translate-x-2 transition-transform">é–‹å§‹è¨‚è£½ <ChevronRight className="w-5 h-5"/></div>
            </button>
            <button onClick={() => startOrder('meal')} className="group bg-white p-6 rounded-[2rem] shadow-xl hover:shadow-2xl transition-all border-2 border-[#f0e6dd] hover:border-[#d4a373] text-left flex flex-col justify-between min-h-[220px] relative overflow-hidden">
               <div className="absolute right-[-20px] bottom-[-20px] opacity-10"><UtensilsCrossed size={150} color="#8b5e3c"/></div>
               <div className="flex items-center space-x-4 mb-4"><div className="bg-[#faedcd] p-3 rounded-full"><UtensilsCrossed className="text-[#8b5e3c] w-8 h-8" /></div><h2 className="text-2xl font-bold text-[#5d4037]">è¼•é£Ÿ</h2></div>
               <p className="text-[#8b5e3c] opacity-70 text-sm md:text-base">ç”œç”œåœˆèˆ‡çˆªç‹€è‚‰é¤…ã€‚<br/>ç‡Ÿé¤Šå‡è¡¡çš„å¯æ„›å°é»å¿ƒã€‚</p>
               <div className="mt-4 flex items-center text-[#d4a373] font-bold group-hover:translate-x-2 transition-transform">é–‹å§‹è¨‚è£½ <ChevronRight className="w-5 h-5"/></div>
            </button>
          </div>
          {cart.length > 0 && (
             <div className="z-10 w-full max-w-2xl px-4 mb-8">
                <button onClick={() => setPage('summary')} className="w-full bg-[#8b5e3c] text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center space-x-2 hover:bg-[#7a5235]">
                    <ShoppingBag className="w-5 h-5" /><span>æŸ¥çœ‹è³¼ç‰©è»Š ({cart.length})</span>
                </button>
             </div>
          )}
          <div className="text-[#d4a373] text-xs opacity-60 pb-6">Â© Ho00p Studio</div>
        </div>
        {toast && (<div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-2xl flex items-center space-x-3 shadow-2xl z-[60] w-max max-w-[90%]">{toast.type === 'error' ? <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0" /> : <Check className="w-5 h-5 text-green-400 flex-shrink-0" />}<span>{toast.message}</span></div>)}
      </PageContainer>
    );
  }

  // 3. Builder Page
  if (page === 'builder') {
    return (
      <PageContainer>
        <header className="bg-white/90 backdrop-blur-md sticky top-0 z-40 px-4 py-3 shadow-sm flex items-center justify-between flex-shrink-0"><button onClick={() => setPage('home')} className="p-2 -ml-2 rounded-full hover:bg-gray-100 text-[#8b5e3c]"><ArrowLeft className="w-6 h-6" /></button><h1 className="text-lg font-bold text-[#5d4037]">{orderType === 'cake' ? 'è¨‚è£½è›‹ç³•' : 'è¨‚è£½è¼•é£Ÿ'}</h1><div className="w-8"></div></header>
        <div className="sticky top-[56px] z-30 bg-[#fdfbf7] shadow-sm flex-shrink-0"><div className="flex space-x-3 overflow-x-auto no-scrollbar p-3">{orderType === 'meal' ? (<CategoryTab id="shape" label="è¼•é£Ÿé¸æ“‡" icon={CATEGORIES_DATA.shape.icon} isActive={activeTab === 'shape'} onClick={setActiveTab} />) : (<><CategoryTab id="meat" label="ä¸»é£Ÿè‚‰é¡" icon={CATEGORIES_DATA.meat.icon} isActive={activeTab === 'meat'} onClick={setActiveTab} /><CategoryTab id="veg" label="è”¬èœé…æ–™" icon={CATEGORIES_DATA.veg.icon} isActive={activeTab === 'veg'} onClick={setActiveTab} /><CategoryTab id="fruit" label="æ°´æœé»ç¶´" icon={CATEGORIES_DATA.fruit.icon} isActive={activeTab === 'fruit'} onClick={setActiveTab} /><CategoryTab id="color" label="æ·‹é¢é¡è‰²" icon={CATEGORIES_DATA.color.icon} isActive={activeTab === 'color'} onClick={setActiveTab} /></>)}</div></div>
        <div ref={scrollRef} className="flex-1 p-4 pb-40 overflow-y-auto scroll-smooth" onScroll={handleScroll}><div className="mb-6 bg-[#fffbf7] p-3 rounded-xl border border-[#f0e6dd] flex items-start"><Info className="w-5 h-5 text-[#d4a373] mr-2 mt-0.5 flex-shrink-0" /><p className="text-sm text-[#8b5e3c]">{activeTab === 'shape' && 'è«‹é¸æ“‡å–œæ­¡çš„è¼•é£Ÿ (å¯å¤šé¸)'}{activeTab === 'meat' && 'è«‹é¸æ“‡è›‹ç™½è³ªä¾†æº (å¿…é¸ï¼Œæœ€å¤š 3 ç¨®)'}{activeTab === 'veg' && 'æ­é…å¥åº·è”¬èœ (æœ€å¤š 3 ç¨®)'}{activeTab === 'fruit' && 'å¤©ç„¶æ°´æœå¢åŠ é¢¨å‘³ (é™é¸ 1 ç¨®)'}{activeTab === 'color' && 'å¤¢å¹»æ·‹é¢ (å¿…é¸ï¼Œé™é¸ 1 ç¨®)'}</p></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{CATEGORIES_DATA[activeTab]?.items?.map(item => (<IngredientCard key={item.id} item={item} category={activeTab} isSelected={selections[activeTab]?.some(i => i.id === item.id)} onToggle={toggleSelection} formatPrice={formatPrice} />))}</div></div>
        <div className={`fixed bottom-6 left-0 right-0 z-50 flex justify-center transition-transform duration-300 ease-in-out ${isCartBarVisible ? 'translate-y-0' : 'translate-y-[120%]'}`}><div className="w-full max-w-[1024px] bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.1)] rounded-t-[2rem] p-6 mx-auto"><div className="flex justify-between items-end mb-4 px-2"><div><p className="text-xs text-[#a67c52] font-medium mb-1">æœ¬é …é‡‘é¡</p><p className="text-4xl font-black text-[#5d4037]">{formatPrice(calculateCurrentItemTotal())}</p></div><div className="text-right"><p className="text-xs text-[#a67c52]">å·²é¸æ“‡</p><p className="text-base font-bold text-[#8b5e3c]">{Object.values(selections).reduce((acc, curr) => acc + curr.length, 0)} é …å…§å®¹</p></div></div><button onClick={handleAddToCart} className="w-full bg-[#8b5e3c] text-white py-4 rounded-xl font-bold text-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center space-x-2 hover:bg-[#7a5235]"><Plus className="w-6 h-6" /><span>åŠ å…¥è³¼ç‰©è»Š</span></button></div></div>
        {toast && (<div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-2xl flex items-center space-x-3 shadow-2xl z-[60] w-max max-w-[90%]">{toast.type === 'error' ? <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0" /> : <Check className="w-5 h-5 text-green-400 flex-shrink-0" />}<span className="font-medium text-sm sm:text-base">{toast.message}</span></div>)}
      </PageContainer>
    );
  }

  // 4. Summary Page
  if (page === 'summary') {
    const subtotal = calculateCartSubtotal();
    const shipping = subtotal >= 1000 ? 0 : 180;
    const finalTotal = subtotal + shipping;

    return (
      <PageContainer>
        <div className="flex items-center justify-between p-4 sticky top-0 bg-[#fdfbf7] z-40"><button onClick={() => setPage('home')} className="p-2 rounded-full hover:bg-[#eae0d5] text-[#8b5e3c] transition-colors"><ArrowLeft className="w-8 h-8" /></button><h2 className="text-xl font-bold text-[#5d4037]">è³¼ç‰©è»Š</h2><div className="w-8"></div></div>
        <div className="flex-1 overflow-y-auto no-scrollbar p-6 pb-40">
           <div className="bg-white rounded-[2rem] shadow-xl p-8 border border-[#f0e6dd] mb-6 relative max-w-2xl mx-auto">
              <div className="absolute top-0 left-0 right-0 h-2 bg-[#d4a373] opacity-20"></div>
              <h2 className="text-3xl font-bold text-center text-[#5d4037] mb-2">è¨‚è³¼æ¸…å–®</h2>
              <p className="text-center text-[#a67c52] text-sm mb-8 border-b border-dashed border-[#d4a373] pb-6">Ho00p å¯µç‰©è›‹ç³•&è¼•é£Ÿ</p>
              <div className="space-y-6 mb-8">
                 {cart.length === 0 ? (<div className="text-center py-10 text-gray-400">è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼</div>) : (cart.map((item, index) => (<div key={item.id} className="bg-[#fdfbf7] p-6 rounded-xl border border-[#f0e6dd] relative"><button onClick={() => removeFromCart(item.id)} className="absolute top-4 right-4 text-gray-400 hover:text-red-500"><Trash2 className="w-5 h-5" /></button><h3 className="text-lg font-bold text-[#8b5e3c] mb-3 flex items-center">{item.type === 'cake' ? <Cake className="w-5 h-5 mr-2"/> : <UtensilsCrossed className="w-5 h-5 mr-2"/>}{item.type === 'cake' ? `å®¢è£½åŒ–è›‹ç³• #${index+1}` : `è¼•é£Ÿé¤é» #${index+1}`}</h3><div className="space-y-2 text-sm text-[#5d4037] mb-3">{item.selections.shape.length > 0 && <div className="flex"><span className="font-bold w-12">é€ å‹ï¼š</span><span>{item.selections.shape.map(i=>i.name).join(', ')}</span></div>}{item.selections.meat.length > 0 && <div className="flex"><span className="font-bold w-12">è‚‰é¡ï¼š</span><span>{item.selections.meat.map(i=>i.name).join(', ')}</span></div>}{item.selections.veg.length > 0 && <div className="flex"><span className="font-bold w-12">è”¬èœï¼š</span><span>{item.selections.veg.map(i=>i.name).join(', ')}</span></div>}{item.selections.fruit.length > 0 && <div className="flex"><span className="font-bold w-12">æ°´æœï¼š</span><span>{item.selections.fruit.map(i=>i.name).join(', ')}</span></div>}{item.selections.color.length > 0 && <div className="flex"><span className="font-bold w-12">æ·‹é¢ï¼š</span><span>{item.selections.color.map(i=>i.name).join(', ')}</span></div>}</div><div className="text-right font-bold text-lg text-[#d4a373]">{formatPrice(item.total)}</div></div>)))}
              </div>
              {cart.length > 0 && (<>
                    <div className="bg-[#e6ccb2] bg-opacity-20 rounded-xl p-6 mb-6 border border-[#d4a373] border-opacity-30">
                        <h3 className="font-bold text-[#8b5e3c] flex items-center mb-4 text-lg"><Wand2 className="w-5 h-5 mr-2 text-[#d4a373]" /> å°å¯¶è²è³‡æ–™</h3>
                        <div className="space-y-4"><div className="flex flex-col sm:flex-row gap-4"><input type="text" placeholder="åå­— (å¦‚: è±†è±†)" value={petName} onChange={(e) => setPetName(e.target.value)} className="flex-1 bg-white border border-[#e6ccb2] rounded-xl px-4 py-3 text-base focus:outline-none focus:border-[#8b5e3c] text-[#5d4037]" /><input type="text" placeholder="ç”¨é€” (å¦‚: 3æ­²ç”Ÿæ—¥, çå‹µ)" value={occasion} onChange={(e) => setOccasion(e.target.value)} className="flex-1 bg-white border border-[#e6ccb2] rounded-xl px-4 py-3 text-base focus:outline-none focus:border-[#8b5e3c] text-[#5d4037]" /></div>{!aiGreeting && (<button onClick={handleSavePetData} className="w-full bg-[#d4a373] text-white py-3 rounded-xl font-bold text-lg shadow-md active:scale-95 transition-all flex justify-center items-center hover:bg-[#c29363]"><Save className="w-5 h-5 mr-2"/> å„²å­˜</button>)}</div>{aiGreeting && <div className="mt-4 bg-white p-4 rounded-xl text-base text-[#5d4037] border-l-4 border-[#d4a373] shadow-sm whitespace-pre-line">{aiGreeting}</div>}
                    </div>
                    {/* çµç®—å€å¡Š */}
                    <div className="mt-6 pt-6 border-t-2 border-[#f0e6dd] space-y-2">
                        <div className="flex justify-between items-center text-[#a67c52]"><span>å•†å“å°è¨ˆ</span><span>{formatPrice(subtotal)}</span></div>
                        <div className="flex justify-between items-center text-[#a67c52]"><span>é‹è²» {subtotal >= 1000 ? '(æ»¿åƒå…é‹)' : '(æœªæ»¿åƒ)'}</span><span>{formatPrice(shipping)}</span></div>
                        <div className="flex justify-between items-center mt-2 pt-2 border-t border-[#f0e6dd]"><span className="text-xl font-bold text-[#5d4037]">è¨‚å–®ç¸½é‡‘é¡</span><span className="text-4xl font-black text-[#8b5e3c]">{formatPrice(finalTotal)}</span></div>
                    </div>
                </>)}
           </div>
           <div className="fixed bottom-0 left-0 right-0 p-6 bg-white border-t border-[#f0e6dd] flex flex-col gap-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]"><button onClick={() => setPage('home')} className="w-full bg-white text-[#8b5e3c] border-2 border-[#8b5e3c] py-4 rounded-xl font-bold text-xl shadow-sm active:scale-95 transition-transform flex items-center justify-center space-x-2 hover:bg-[#f0e6dd]"><Plus className="w-6 h-6" /><span>ç¹¼çºŒé»é¤</span></button>{cart.length > 0 && (<button onClick={handleCopy} className="w-full bg-[#06C755] text-white py-4 rounded-xl font-bold text-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center space-x-2 hover:bg-[#05b34c]"><Copy className="w-6 h-6" /><span>è¤‡è£½è¨‚å–®ä¸¦å‰å¾€ LINE</span></button>)}</div>
        </div>
        {toast && (<div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-2xl flex items-center space-x-3 shadow-2xl z-[60] w-max max-w-[90%]">{toast.type === 'error' ? <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0" /> : <Check className="w-5 h-5 text-green-400 flex-shrink-0" />}<span>{toast.message}</span></div>)}
      </PageContainer>
    );
  }

  return null;
};

export default Ho00pApp;
